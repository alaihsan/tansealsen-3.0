{% extends "base.html" %}

{% block title %}Riwayat Pelanggaran - {{ student.name }}{% endblock %}

{% block content %}
<!-- Alpine Data Scope -->
<div class="max-w-5xl mx-auto px-4 py-8 w-full" x-data="{
    modalOpen: false,
    remissionFormOpen: false,
    deleteConfirmOpen: false,
    deleteInput: '',
    activeViolation: null,
    photoIndex: 0,
    
    openModal(violation) {
        this.activeViolation = violation;
        this.photoIndex = 0;
        this.modalOpen = true;
        this.remissionFormOpen = false; 
        this.deleteConfirmOpen = false;
        this.deleteInput = '';
        document.body.style.overflow = 'hidden';
    },
    closeModal() {
        this.modalOpen = false;
        this.activeViolation = null;
        document.body.style.overflow = '';
    },
    nextPhoto() {
        if (this.activeViolation && this.activeViolation.photos.length > 0) {
            this.photoIndex = (this.photoIndex + 1) % this.activeViolation.photos.length;
        }
    },
    prevPhoto() {
        if (this.activeViolation && this.activeViolation.photos.length > 0) {
            this.photoIndex = (this.photoIndex - 1 + this.activeViolation.photos.length) % this.activeViolation.photos.length;
        }
    },
    printActiveViolation() {
        if (this.activeViolation) {
            window.open('/violation/print/' + this.activeViolation.id, '_blank');
        }
    }
}">

    <div class="mb-6">
        <a href="{{ url_for('main.home') }}" class="text-blue-600 hover:text-blue-800 text-sm font-medium mb-2 inline-flex items-center transition-colors">
            <i class="fas fa-arrow-left mr-2"></i> Kembali ke Dashboard
        </a>
        
        <!-- Header Info Siswa -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-2xl border-4 border-white shadow-sm">
                    {{ student.name[:2] }}
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 leading-tight">{{ student.name }}</h1>
                    <div class="flex flex-wrap gap-3 text-sm text-gray-500 mt-1">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-700">
                            <i class="fas fa-id-card mr-1.5 text-gray-400"></i> NIS: {{ student.nis }}
                        </span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                            <i class="fas fa-chalkboard-teacher mr-1.5"></i> Kelas {{ student.classroom.name }}
                        </span>
                    </div>
                </div>
            </div>
            
            
        </div>
    </div>

    <!-- Timeline / List Pelanggaran -->
    <div class="space-y-4 relative">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-gray-800 flex items-center">
                <span class="bg-blue-600 w-1 h-6 rounded-full mr-3"></span>
                Riwayat Pelanggaran
            </h2>
            <span class="text-sm text-gray-500">{{ student.violations|length }} Data ditemukan</span>
        </div>
        
        {% for v in student.violations|sort(attribute='date_posted', reverse=True) %}
        <!-- KARTU PELANGGARAN -->
        <div class="bg-white p-4 sm:p-5 rounded-xl border {{ 'border-green-200 bg-green-50/50' if v.is_remitted else 'border-gray-200 hover:border-blue-400' }} shadow-sm hover:shadow-md transition-all duration-200 relative overflow-hidden group">
            
            <!-- Badge status jika remisi -->
            {% if v.is_remitted %}
            <div class="absolute top-0 right-0 bg-green-500 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-sm z-10 flex items-center gap-1">
                <i class="fas fa-check-circle"></i> SELESAI
            </div>
            {% endif %}

            <!-- Area Klik Utama -->
            {% set _ayat_text = '' %}{% for a in v.ayats %}{% if loop.first %}{% set _ayat_text = a.description %}{% else %}{% set _ayat_text = _ayat_text + ', ' + a.description %}{% endif %}{% endfor %}
            <div class="cursor-pointer" @click="openModal({
                id: {{ v.id }},
                date: '{{ v.tanggal_kejadian }}',
                category: '{{ v.kategori_pelanggaran }}',
                points: {{ v.points }},
                pasal: '{{ v.pasal or '-' }}',
                pasal_with_ayats: {{ ((v.pasal or '-') ~ ((' - ' ~ _ayat_text) if _ayat_text else ''))|tojson }},
                description: `{{ v.description|replace('`', '\`')|replace('\n', '<br>') }}`,
                reporter: '{{ v.di_input_oleh or '-' }}',
                is_remitted: {{ 'true' if v.is_remitted else 'false' }},
                remission_reason: '{{ v.remission_reason or '' }}',
                remission_date: '{{ v.remission_date.strftime('%d/%m/%Y') if v.remission_date else '' }}',
                photos: [
                    {% for p in v.photos %}
                        '{{ url_for('static', filename='uploads/' + p.filename) }}'{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            })">
                <div class="flex flex-col sm:flex-row sm:items-start gap-5">
                    <!-- Thumbnail Foto -->
                    <div class="flex-shrink-0 relative group-card-hover">
                        {% if v.photos|length > 0 %}
                            <div class="relative w-full sm:w-24 sm:h-24 h-48 overflow-hidden rounded-lg shadow-sm border border-gray-200">
                                <img src="{{ url_for('static', filename='uploads/' + v.photos[0].filename) }}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 {{ 'opacity-60 grayscale' if v.is_remitted }}">
                                {% if v.photos|length > 1 %}
                                    <div class="absolute bottom-0 right-0 bg-black/60 backdrop-blur-sm text-white text-[10px] font-bold px-2 py-1 rounded-tl-lg">
                                        +{{ v.photos|length - 1 }} Foto
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="w-24 h-24 rounded-lg bg-gray-50 border border-gray-200 flex flex-col items-center justify-center text-gray-300 hidden sm:flex">
                                <i class="fas fa-camera text-2xl mb-1"></i>
                                <span class="text-[10px]">No Image</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="flex-grow min-w-0">
                        <!-- Baris Atas: Tanggal & Kategori -->
                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <span class="text-xs font-semibold text-gray-500 bg-gray-100 px-2 py-1 rounded border border-gray-200 flex items-center">
                                <i class="far fa-calendar-alt mr-1.5"></i> {{ v.tanggal_kejadian }}
                            </span>
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border {{ 'bg-green-100 text-green-700 border-green-200' if v.kategori_pelanggaran == 'Ringan' else 'bg-yellow-100 text-yellow-700 border-yellow-200' if v.kategori_pelanggaran == 'Sedang' else 'bg-red-100 text-red-700 border-red-200' }}">
                                {{ v.kategori_pelanggaran }}
                            </span>
                        </div>
                        
                        <!-- Judul Pasal -->
                        <h3 class="font-bold text-gray-900 text-lg mb-1 leading-snug group-hover:text-blue-600 transition-colors {{ 'line-through text-gray-400' if v.is_remitted }}">
                            {{ v.pasal }}{% if v.ayats|length > 0 %} - {% for a in v.ayats %}{{ a.description }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}
                        </h3>
                        
                        <!-- Deskripsi Singkat -->
                        <p class="text-sm text-gray-600 line-clamp-2 leading-relaxed mb-2">{{ v.description }}</p>
                        
                        <!-- Reporter -->
                        <div class="flex items-center gap-2 mt-auto">
                            <div class="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center text-[10px] text-gray-600 font-bold">
                                {{ (v.di_input_oleh or 'S')[0] }}
                            </div>
                            <span class="text-xs text-gray-500">{{ v.di_input_oleh or 'System' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOMBOL PRINT (Di Card) -->
            <div class="absolute bottom-4 right-4 z-20 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                <a href="{{ url_for('main.print_violation', violation_id=v.id) }}" target="_blank" @click.stop class="bg-white hover:bg-blue-50 text-gray-500 hover:text-blue-600 p-2 rounded-lg shadow border border-gray-200 transition-all flex items-center gap-2 text-xs font-medium" title="Cetak Bukti">
                    <i class="fas fa-print text-sm"></i> <span class="hidden sm:inline">Cetak</span>
                </a>
            </div>

        </div>
        {% else %}
        <!-- State Kosong -->
        <div class="text-center py-16 bg-white rounded-xl border border-dashed border-gray-300">
            <div class="bg-green-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                <i class="fas fa-medal text-3xl text-green-500"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900">Catatan Bersih!</h3>
            <p class="text-gray-500 text-sm mt-1">Siswa ini belum memiliki catatan pelanggaran.</p>
        </div>
        {% endfor %}
    </div>

    <!-- MODAL DETAIL DI-PERCANTIK -->
    <div x-show="modalOpen" class="fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-6" style="display: none;" x-cloak>
        
        <!-- Backdrop Blur -->
        <div class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm transition-opacity duration-300" 
             x-show="modalOpen"
             x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
             @click="closeModal()"></div>

        <!-- Modal Container -->
        <div class="relative w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-5xl flex flex-col md:flex-row bg-white sm:rounded-2xl overflow-hidden shadow-2xl transform transition-all duration-300"
             x-show="modalOpen"
             x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             @click.stop>
            
            <!-- Tombol Close Mobile -->
            <button @click="closeModal()" class="absolute top-4 right-4 text-white md:hidden z-50 bg-black/50 backdrop-blur rounded-full w-9 h-9 flex items-center justify-center hover:bg-black/70 transition-colors">
                <i class="fas fa-times"></i>
            </button>

            <!-- BAGIAN KIRI: GALERI FOTO -->
            <div class="w-full md:w-[55%] bg-black flex items-center justify-center relative min-h-[300px] md:min-h-[500px] group bg-neutral-900">
                
                <!-- Navigasi Foto -->
                <button x-show="activeViolation && activeViolation.photos.length > 1" @click="prevPhoto()" class="absolute left-4 text-white hover:text-white p-2 z-10 bg-white/10 hover:bg-white/30 backdrop-blur rounded-full w-10 h-10 flex items-center justify-center transition-all opacity-0 group-hover:opacity-100">
                    <i class="fas fa-chevron-left"></i>
                </button>

                <!-- Tampilan Foto -->
                <template x-if="activeViolation && activeViolation.photos.length > 0">
                    <img :src="activeViolation.photos[photoIndex]" class="max-w-full max-h-[50vh] md:max-h-full object-contain shadow-2xl">
                </template>
                
                <!-- State Kosong Foto -->
                <template x-if="!activeViolation || activeViolation.photos.length === 0">
                    <div class="text-gray-500 flex flex-col items-center justify-center h-full w-full bg-neutral-900 select-none">
                        <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center mb-4">
                            <i class="far fa-image text-3xl opacity-50"></i>
                        </div>
                        <p class="text-sm opacity-50 font-medium">Tidak ada bukti foto terlampir</p>
                    </div>
                </template>

                <button x-show="activeViolation && activeViolation.photos.length > 1" @click="nextPhoto()" class="absolute right-4 text-white hover:text-white p-2 z-10 bg-white/10 hover:bg-white/30 backdrop-blur rounded-full w-10 h-10 flex items-center justify-center transition-all opacity-0 group-hover:opacity-100">
                    <i class="fas fa-chevron-right"></i>
                </button>
                
                <!-- Indikator Foto -->
                <div x-show="activeViolation && activeViolation.photos.length > 0" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 text-white text-xs font-bold px-4 py-1.5 bg-black/60 rounded-full backdrop-blur-md border border-white/10 tracking-widest">
                    <span x-text="photoIndex + 1"></span> / <span x-text="activeViolation.photos.length"></span>
                </div>
            </div>

            <!-- BAGIAN KANAN: DETAIL & AKSI -->
            <div class="w-full md:w-[45%] bg-white flex flex-col h-full relative z-0">
                
                <!-- Header Modal -->
                <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-start bg-white sticky top-0 z-10">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                             <span class="px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wider border" 
                                   :class="{
                                       'bg-green-50 text-green-700 border-green-100': activeViolation?.category === 'Ringan',
                                       'bg-yellow-50 text-yellow-700 border-yellow-100': activeViolation?.category === 'Sedang',
                                       'bg-red-50 text-red-700 border-red-100': activeViolation?.category === 'Berat'
                                   }"
                                   x-text="activeViolation?.category || 'UMUM'">
                             </span>
                             <span class="text-xs text-gray-400 font-medium flex items-center gap-1">
                                <i class="far fa-clock text-[10px]"></i> <span x-text="activeViolation?.date"></span>
                             </span>
                        </div>
                        <h3 class="font-bold text-gray-900 text-xl leading-snug pr-8" x-text="activeViolation?.pasal_with_ayats || activeViolation?.pasal || 'Detail Pelanggaran'"></h3>
                    </div>
                    
                    <!-- Tombol Close Desktop -->
                    <button @click="closeModal()" class="text-gray-300 hover:text-gray-500 hover:bg-gray-100 p-2 rounded-full transition-colors hidden md:block">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Konten Scrollable -->
                <div class="p-6 overflow-y-auto flex-grow space-y-6 relative custom-scrollbar">
                    
                    <!-- STATUS REMISI -->
                    <div x-show="activeViolation?.is_remitted" class="bg-green-50 p-4 rounded-xl border border-green-100 flex items-start gap-3">
                        <i class="fas fa-check-circle text-green-600 text-xl mt-0.5"></i>
                        <div>
                            <p class="text-sm font-bold text-green-800 uppercase tracking-wide">Pelanggaran Selesai</p>
                            <p class="text-xs text-green-700 mt-1">Alasan Remisi:</p>
                            <p class="text-sm text-green-900 italic font-medium" x-text="'&ldquo;' + activeViolation?.remission_reason + '&rdquo;'"></p>
                            <p class="text-[10px] text-green-600 mt-2 font-mono">Diremisi pada: <span x-text="activeViolation?.remission_date"></span></p>
                        </div>
                    </div>

                    <!-- DESKRIPSI (SCROLLABLE AREA) -->
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-1">
                            <i class="fas fa-align-left"></i> Kronologi Kejadian
                        </h4>
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-gray-700 text-sm leading-relaxed max-h-[200px] overflow-y-auto shadow-inner" x-html="activeViolation?.description"></div>
                    </div>

                    <!-- REPORTER INFO -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-sm font-bold">
                                <i class="fas fa-user-edit"></i>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-400 uppercase font-bold">Pencatat</p>
                                <p class="text-sm font-bold text-gray-900 truncate max-w-[100px]" x-text="activeViolation?.reporter"></p>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Footer Action Buttons (Fixed Bottom) -->
                <div class="p-5 border-t border-gray-100 bg-gray-50/80 backdrop-blur-sm z-20">
                    <div class="grid grid-cols-3 gap-3">
                        
                        <!-- 1. Tombol Cetak -->
                        <button @click="printActiveViolation()" class="flex flex-col items-center justify-center py-2.5 px-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm group">
                            <i class="fas fa-print text-lg mb-1 group-hover:scale-110 transition-transform"></i>
                            <span class="text-[10px] font-bold uppercase">Cetak</span>
                        </button>

                        <!-- 2. Tombol Remisi -->
                        <button x-show="!activeViolation?.is_remitted" @click="remissionFormOpen = true" class="flex flex-col items-center justify-center py-2.5 px-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all shadow-md hover:shadow-lg group">
                            <i class="fas fa-check-circle text-lg mb-1 group-hover:scale-110 transition-transform"></i>
                            <span class="text-[10px] font-bold uppercase">Remisi</span>
                        </button>
                        <!-- Disabled Remisi -->
                        <button x-show="activeViolation?.is_remitted" disabled class="flex flex-col items-center justify-center py-2.5 px-2 bg-gray-100 text-gray-400 rounded-lg cursor-not-allowed opacity-70">
                            <i class="fas fa-check-double text-lg mb-1"></i>
                            <span class="text-[10px] font-bold uppercase">Selesai</span>
                        </button>
                        
                        <!-- 3. Tombol Hapus -->
                        <button @click="deleteConfirmOpen = true" class="flex flex-col items-center justify-center py-2.5 px-2 bg-white border border-red-100 text-red-500 rounded-lg hover:bg-red-50 hover:border-red-200 transition-all shadow-sm group">
                            <i class="fas fa-trash-alt text-lg mb-1 group-hover:scale-110 transition-transform"></i>
                            <span class="text-[10px] font-bold uppercase">Hapus</span>
                        </button>
                    </div>
                </div>

                <!-- OVERLAY: FORM REMISI -->
                <div x-show="remissionFormOpen" class="absolute inset-0 bg-white z-30 p-6 animate-fade-in-up flex flex-col h-full" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-10" x-transition:enter-end="opacity-100 translate-y-0">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="font-bold text-gray-900 text-lg flex items-center gap-2"><i class="fas fa-hand-holding-heart text-green-500"></i> Berikan Remisi</h4>
                        <button @click="remissionFormOpen = false" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                        <p class="text-xs text-blue-800 leading-relaxed">
                            <span class="font-bold">Info:</span> Pelanggaran ini akan ditandai <span class="font-bold">SELESAI</span>. Poin pelanggaran tidak akan dihitung lagi dalam total poin aktif siswa.
                        </p>
                    </div>

                    <form :action="'/violation/remit/' + activeViolation?.id" method="POST" class="flex-grow flex flex-col">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Alasan Remisi <span class="text-red-500">*</span></label>
                        <textarea name="remission_reason" rows="4" required placeholder="Contoh: Siswa telah menyelesaikan sanksi membersihkan perpustakaan..." class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none resize-none shadow-sm"></textarea>
                        
                        <div class="mt-auto grid grid-cols-2 gap-3 pt-6">
                            <button type="button" @click="remissionFormOpen = false" class="py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition-colors">Batal</button>
                            <button type="submit" class="py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg shadow-green-200 transition-all transform active:scale-95">Simpan</button>
                        </div>
                    </form>
                </div>

                <!-- OVERLAY: KONFIRMASI HAPUS -->
                <div x-show="deleteConfirmOpen" class="absolute inset-0 bg-white z-40 p-6 flex flex-col justify-center items-center text-center h-full" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
                    
                    <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mb-6 animate-pulse">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                    </div>
                    
                    <h4 class="font-black text-gray-900 text-2xl mb-2">Hapus Data?</h4>
                    <p class="text-gray-500 text-sm mb-8 max-w-[250px]">Tindakan ini permanen. Data pelanggaran dan foto bukti akan hilang selamanya.</p>

                    <div class="w-full mb-8">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-2">Ketik "SETUJU" untuk konfirmasi</p>
                        <input type="text" x-model="deleteInput" placeholder="SETUJU" class="w-full text-center border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-gray-800 focus:border-red-500 focus:ring-0 outline-none uppercase tracking-widest transition-colors">
                    </div>

                    <div class="flex gap-3 w-full">
                        <button @click="deleteConfirmOpen = false" class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50 transition-colors">Batal</button>
                        
                        <form :action="'/violation/delete/' + activeViolation?.id" method="POST" class="flex-1">
                            <button type="submit" :disabled="deleteInput.toUpperCase() !== 'SETUJU'" class="w-full py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 shadow-lg shadow-red-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none transition-all transform active:scale-95">
                                Hapus
                            </button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar untuk Modal */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
</style>
{% endblock %}